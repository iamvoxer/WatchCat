<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WatchCat - Dashboard</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />

    <!-- Shoelace CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.1/cdn/themes/light.css"
    />

    <link rel="stylesheet" href="index.css" />
    <link rel="stylesheet" href="server/server.css" />
    <link rel="stylesheet" href="watch/watch.css" />
  </head>
  <body>
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="logo.png" alt="WatchCat Logo" class="sidebar-logo" />
        <h1>WatchCat</h1>
      </div>

      <nav>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="#" class="nav-link active" data-section="dashboard">
              üìä Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" data-section="servers"> üñ•Ô∏è Server </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" data-section="applications">
              ‚öôÔ∏è Application
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" data-section="watch-templates">
              üìã Watch
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" data-section="alerts"> üö® Alert </a>
          </li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <header class="header">
        <h2 id="pageTitle">Dashboard</h2>
        <div class="header-actions">
          <span class="user-name" id="headerUserName">Loading...</span>
          <button class="btn btn-primary" id="changePasswordBtn">
            üîí Change Password
          </button>
          <button class="btn btn-danger" id="headerLogoutBtn">üö™ Logout</button>
        </div>
      </header>

      <!-- Dashboard Section -->
      <section class="content-section active" id="dashboard">
        <div class="dashboard-cards">
          <div class="card">
            <h3>Total Servers</h3>
            <div class="value" id="totalServers">0</div>
            <div class="label">Monitored Servers</div>
          </div>
          <div class="card">
            <h3>Online Servers</h3>
            <div class="value" id="onlineServers">0</div>
            <div class="label">Currently Active</div>
          </div>
          <div class="card">
            <h3>Total Applications</h3>
            <div class="value" id="totalApplications">0</div>
            <div class="label">Monitored Applications</div>
          </div>
          <div class="card">
            <h3>Active Alerts</h3>
            <div class="value" id="activeAlerts">0</div>
            <div class="label">Requires Attention</div>
          </div>
        </div>

        <h3>Recent Activity</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Server</th>
              <th>Event</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="recentActivity">
            <tr>
              <td colspan="4" style="text-align: center; color: #666">
                No recent activity
              </td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Server Management Section -->
      <section class="content-section" id="servers">
        <div class="server-header">
          <h3>Server Management</h3>
          <button class="btn btn-primary" id="addServerBtn">
            + Add Server
          </button>
        </div>

        <div class="server-list" id="serverContainer">
          <div class="loading-message">Loading servers...</div>
        </div>

        <!-- Server Form Sidebar -->
        <div class="server-sidebar-overlay" id="serverSidebarOverlay"></div>
        <div class="server-sidebar" id="serverSidebar">
          <div class="server-sidebar-header">
            <h3 id="serverSidebarTitle">Add Server</h3>
            <button class="server-sidebar-close" id="serverSidebarClose">
              &times;
            </button>
          </div>
          <div class="server-sidebar-content">
            <form id="serverForm">
              <div class="form-group">
                <label for="serverName">Server Name *</label>
                <sl-input
                  id="serverName"
                  name="name"
                  required
                  placeholder="Enter server name"
                ></sl-input>
              </div>

              <div class="form-group">
                <label for="serverIP">IP Address *</label>
                <sl-input
                  id="serverIP"
                  name="ip"
                  required
                  placeholder="192.168.1.100"
                ></sl-input>
              </div>

              <div class="form-group">
                <label for="serverDesc">Description</label>
                <sl-textarea
                  id="serverDesc"
                  name="desc"
                  rows="3"
                  placeholder="Optional description"
                ></sl-textarea>
              </div>

              <div class="form-group">
                <label for="serverUsername">Username</label>
                <sl-input
                  id="serverUsername"
                  name="username"
                  placeholder="root"
                  value="root"
                ></sl-input>
              </div>

              <div class="form-group">
                <label for="serverPassword">Password</label>
                <sl-input
                  type="password"
                  id="serverPassword"
                  name="password"
                  placeholder="Enter password"
                  password-toggle
                ></sl-input>
              </div>

              <div class="form-actions">
                <sl-button variant="default" id="serverFormCancel">
                  Cancel
                </sl-button>
                <sl-button
                  variant="primary"
                  type="submit"
                  id="serverFormSubmit"
                >
                  <span id="serverFormSubmitText">Add Server</span>
                </sl-button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Application Management Section -->
      <section class="content-section" id="applications">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
          "
        >
          <h3>Application List</h3>
          <button class="btn btn-primary" id="addApplicationBtn">
            + Add Application
          </button>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Application Name</th>
              <th>Server</th>
              <th>Type</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="applicationList">
            <tr>
              <td colspan="5" style="text-align: center; color: #666">
                No applications configured
              </td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Watch Templates Section -->
      <section class="content-section" id="watch-templates">
        <!-- Template List -->
        <div class="templates-container" id="templatesContainer">
          <div class="loading-message">
            <div class="loading-spinner"></div>
            <p>Loading watch templates...</p>
          </div>
        </div>
      </section>

      <!-- Alert Management Section -->
      <section class="content-section" id="alerts">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
          "
        >
          <h3>Alert Rules</h3>
          <button class="btn btn-primary" id="addAlertBtn">
            + Add Alert Rule
          </button>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Rule Name</th>
              <th>Condition</th>
              <th>Threshold</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="alertList">
            <tr>
              <td colspan="5" style="text-align: center; color: #666">
                No alert rules configured
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>

    <div class="connection-status disconnected" id="connectionStatus">
      Disconnected
    </div>

    <!-- Global Confirm Dialog -->
    <sl-dialog label="Confirm Action" id="globalConfirmDialog">
      <p id="confirmMessage">Are you sure?</p>
      <sl-button slot="footer" variant="default" id="confirmCancel"
        >Cancel</sl-button
      >
      <sl-button slot="footer" variant="primary" id="confirmOk"
        >Confirm</sl-button
      >
    </sl-dialog>

    <script>
      // Simple Shoelace-based toast system
      window.showToast = async function (
        message,
        type = "info",
        title = null,
        duration = 5000
      ) {
        // Ensure sl-alert is registered before creating
        await customElements.whenDefined('sl-alert');
        // Map error to danger for Shoelace variant
        const variant =
          type === "error" ? "danger" : type === "info" ? "primary" : type;

        // Icon mapping
        const icons = {
          success: "check-circle",
          danger: "exclamation-triangle",
          warning: "exclamation-triangle",
          primary: "info-circle",
        };

        // Create alert element (like in official examples)
        const alert = document.createElement("sl-alert");
        alert.variant = variant;
        alert.closable = true;
        alert.duration = duration;

        alert.innerHTML = `
          <sl-icon slot="icon" name="${icons[variant]}"></sl-icon>
          ${title ? `<strong>${title}</strong><br>` : ""}${message}
        `;

        // Add to DOM first
        document.body.appendChild(alert);
        setTimeout(() => {
          alert.toast();
        }, 200);

        return alert;
      };

      // Simple Shoelace-based confirmation dialog
      let confirmResolve = null;

      window.showConfirm = function (message, title = "Confirm Action") {
        return new Promise((resolve) => {
          const dialog = document.getElementById("globalConfirmDialog");
          const messageEl = document.getElementById("confirmMessage");

          // Set content
          dialog.label = title;
          messageEl.textContent = message;

          // Store resolve function
          confirmResolve = resolve;

          // Show dialog and ensure proper focus management
          dialog.show();

          // Ensure dialog is properly focused after showing
          setTimeout(() => {
            if (dialog.shadowRoot) {
              const panel = dialog.shadowRoot.querySelector('[role="dialog"]');
              if (panel) {
                panel.focus();
              }
            }
          }, 100);
        });
      };

      // Setup confirm dialog event listeners
      document.addEventListener("DOMContentLoaded", function () {
        const dialog = document.getElementById("globalConfirmDialog");
        const cancelBtn = document.getElementById("confirmCancel");
        const okBtn = document.getElementById("confirmOk");

        // Helper function to close dialog properly
        const closeDialog = (result) => {
          // Clear focus from any internal elements before hiding
          if (dialog.shadowRoot) {
            const focusedElement = dialog.shadowRoot.activeElement;
            if (focusedElement) {
              focusedElement.blur();
            }
          }

          dialog.hide();

          if (confirmResolve) {
            confirmResolve(result);
            confirmResolve = null;
          }
        };

        cancelBtn.addEventListener("click", () => {
          closeDialog(false);
        });

        okBtn.addEventListener("click", () => {
          closeDialog(true);
        });

        // Handle ESC key or backdrop click
        dialog.addEventListener("sl-hide", () => {
          if (confirmResolve) {
            confirmResolve(false);
            confirmResolve = null;
          }
        });
      });

      // Convenience methods
      window.showSuccess = function (message, title, duration) {
        return showToast(message, "success", title, duration);
      };

      window.showError = function (message, title, duration) {
        return showToast(message, "error", title, duration);
      };

      window.showWarning = function (message, title, duration) {
        return showToast(message, "warning", title, duration);
      };

      window.showInfo = function (message, title, duration) {
        return showToast(message, "info", title, duration);
      };
    </script>

    <!-- Shoelace JS -->
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.1/cdn/shoelace-autoloader.js"
    ></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="index.js"></script>
    <script src="server/server.js"></script>
    <script src="watch/watch.js"></script>
  </body>
</html>
